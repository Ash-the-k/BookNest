<div class="container fade-in">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <% if (isInLibrary) { %>
        <li class="breadcrumb-item"><a href="/books">Library</a></li>
      <% } else { %>
        <li class="breadcrumb-item"><a href="/books/search">Search</a></li>
      <% } %>
      <li class="breadcrumb-item active" aria-current="page"><%= book.title %></li>
    </ol>
  </nav>

  <div class="row g-5">
    <div class="col-md-4 text-center">
      
      <div class="book-cover-container shadow-lg rounded">
        <% if (isInLibrary) { %>
             <% 
               let statusClass = '';
               if (book.status === 'wishlist') statusClass = 'wishlist';
               else if (book.status === 'reading') statusClass = 'reading';
               else if (book.status === 'completed') statusClass = 'completed';
               else if (book.status === 'dropped') statusClass = 'dropped';
             %>
             <div class="ribbon <%= statusClass %>"><%= book.status %></div>
        <% } %>
        
        <% if (olExtras?.cover_urls?.large || olExtras?.cover_urls?.medium) { %>
          <img src="<%= olExtras.cover_urls.large || olExtras.cover_urls.medium %>" 
               class="img-fluid" 
               alt="Cover">
        <% } else { %>
            <div class="bg-secondary text-white d-flex align-items-center justify-content-center" 
                 style="width: 250px; height: 350px;">No Cover</div>
        <% } %>
      </div>

      <div class="mt-4 p-3 bg-white border rounded">
        <h5 class="brand-font">Ratings</h5>
        
        <% if (book.rating_tag) { %>
          <div class="mb-2">
            <strong>You:</strong> 
            <% 
              let ratingClass = 'bg-secondary';
              if (book.rating_tag === 'perfection') ratingClass = 'badge-perfection';
              if (book.rating_tag === 'go_for_it') ratingClass = 'badge-go-for-it';
              if (book.rating_tag === 'time_pass') ratingClass = 'badge-time-pass';
              if (book.rating_tag === 'skip') ratingClass = 'badge-skip';
            %>
            <span class="badge <%= ratingClass %> rounded-pill">
              <%= book.rating_tag.replaceAll('_', ' ') %>
            </span>
          </div>
        <% } %>

        <div>
          <strong>Open Library:</strong>
          <% if (olExtras?.ol_rating && olExtras.ol_rating.count > 0) { %>
            <span class="text-warning">‚≠ê <%= Number(olExtras.ol_rating.average).toFixed(1) %></span>
            <small class="text-muted">(<%= olExtras.ol_rating.count %>)</small>
          <% } else { %>
            <span class="text-muted">N/A</span>
          <% } %>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <h1 class="display-4 brand-font"><%= book.title %></h1>
      <h4 class="text-muted mb-4">by <%= book.author %></h4>

      <% if (olExtras?.description) { %>
        <div class="card border-0 mb-4 shadow-sm">
          <div class="card-body description-box bg-white rounded">
            
            <div class="description-content" id="descContent">
              <p class="card-text" style="white-space: pre-line;">
                <%= olExtras.description %>
              </p>
              <div class="description-fade"></div>
            </div>

            <div class="text-center">
                <button class="read-more-btn" id="readMoreBtn" onclick="toggleDescription()">
                    Read more
                </button>
            </div>

          </div>
        </div>
      <% } %>

      <% if (olExtras?.ia_preview?.url) { %>
        <a href="<%= olExtras.ia_preview.url %>" target="_blank" class="btn btn-outline-secondary mb-4">
          üìñ Read on Internet Archive
        </a>
      <% } %>

      <hr>

      <div class="d-flex flex-wrap gap-2 mb-4">
        
        <% if (!isInLibrary || book.status !== 'completed') { %>
           <% if (isInLibrary) { %>
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalMarkCompleted">Mark as Completed</button>
           <% } else { %>
              <form method="POST" action="/books/action/mark-completed">
                <input type="hidden" name="work_olid" value="<%= book.work_olid %>" />
                <input type="hidden" name="edition_olid" value="<%= book.edition_olid %>" />
                <input type="hidden" name="title" value="<%= book.title %>" />
                <input type="hidden" name="author" value="<%= book.author %>" />
                <button type="submit" class="btn btn-success">Mark as Completed</button>
              </form>
           <% } %>
        <% } %>

        <% if (!isInLibrary || book.status !== 'reading') { %>
            <% if (isInLibrary) { %>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalStartReading">Start Reading</button>
            <% } else { %>
              <form method="POST" action="/books/action/start-reading">
                <input type="hidden" name="work_olid" value="<%= book.work_olid %>" />
                <input type="hidden" name="edition_olid" value="<%= book.edition_olid %>" />
                <input type="hidden" name="title" value="<%= book.title %>" />
                <input type="hidden" name="author" value="<%= book.author %>" />
                <button type="submit" class="btn btn-primary">Start Reading</button>
              </form>
            <% } %>
        <% } %>

        <% if (!isInLibrary || book.status !== 'wishlist') { %>
            <% if (isInLibrary) { %>
               <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalWishlist">Move to Wishlist</button>
            <% } else { %>
               <form method="POST" action="/books/action/move-to-wishlist">
                <input type="hidden" name="work_olid" value="<%= book.work_olid %>" />
                <input type="hidden" name="edition_olid" value="<%= book.edition_olid %>" />
                <input type="hidden" name="title" value="<%= book.title %>" />
                <input type="hidden" name="author" value="<%= book.author %>" />
                <button type="submit" class="btn btn-secondary">Move to Wishlist</button>
               </form>
            <% } %>
        <% } %>

        <% if (!isInLibrary || (!book.rating_tag && book.status !== 'dropped')) { %>
            <% if (isInLibrary) { %>
              <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalDrop">Drop Book</button>
            <% } else { %>
               <form method="POST" action="/books/action/drop">
                <input type="hidden" name="work_olid" value="<%= book.work_olid %>" />
                <input type="hidden" name="edition_olid" value="<%= book.edition_olid %>" />
                <input type="hidden" name="title" value="<%= book.title %>" />
                <input type="hidden" name="author" value="<%= book.author %>" />
                <button type="submit" class="btn btn-danger">Drop Book</button>
               </form>
            <% } %>
        <% } %>
      </div>

      <% if (isInLibrary) { %>
        
        <div class="row mb-4">
          <div class="col-6">
            <div class="p-3 border rounded h-100 bg-white">
               <small class="text-uppercase text-muted" style="letter-spacing: 1px;">Started</small>
               <div class="d-flex align-items-center mt-1">
                   <span class="fs-5 brand-font"><%= book.started_date || '‚Äî' %></span>
                   
                   <% if (book.status === 'reading' || book.status === 'completed' || book.started_date) { %>
                     <a href="#" data-bs-toggle="modal" data-bs-target="#modalEditStarted" 
                        class="btn-edit-stamp">Edit</a>
                   <% } %>
               </div>
            </div>
          </div>

          <div class="col-6">
            <div class="p-3 border rounded h-100 bg-white">
               <small class="text-uppercase text-muted" style="letter-spacing: 1px;">Completed</small>
               <div class="d-flex align-items-center mt-1">
                   <span class="fs-5 brand-font"><%= book.completed_date || '‚Äî' %></span>
                   
                   <% if (book.status === 'completed' || book.completed_date) { %>
                     <a href="#" data-bs-toggle="modal" data-bs-target="#modalEditCompleted" 
                        class="btn-edit-stamp">Edit</a>
                   <% } %>
               </div>
            </div>
          </div>
        </div>

        <hr />

        <h3 class="mt-5 mb-4 brand-font border-bottom pb-2" style="border-color: var(--accent-sepia) !important;">
            Reader's Log
        </h3>

        <% if (reviews.length === 0) { %>
          <div class="text-center py-4 text-muted" style="border: 2px dashed #e0dace; border-radius: 8px;">
            <p class="mb-0">No entries recorded yet.</p>
          </div>
        <% } else { %>
          
          <div class="d-flex flex-column gap-3">
            <% reviews.forEach(review => { %>
              
              <div class="review-card">
                
                <div class="d-flex justify-content-between align-items-center review-meta">
                    <small class="text-uppercase text-muted" style="letter-spacing: 1px; font-size: 0.7rem;">
                        Recorded Entry
                    </small>

                    <% 
                        let badgeClass = 'bg-secondary'; 
                        let statusLabel = review.status_at_time;

                        if (review.status_at_time === 'completed') badgeClass = 'badge-go-for-it';
                        if (review.status_at_time === 'dropped')   badgeClass = 'badge-skip';
                        if (review.status_at_time === 'reading')   badgeClass = 'badge-time-pass';
                    %>
                    <span class="badge <%= badgeClass %> rounded-pill" style="font-size: 0.7rem;">
                        <%= statusLabel %>
                    </span>
                </div>

                <p class="review-text mb-0">
                    <%= review.content %>
                </p>

              </div>

            <% }) %>
          </div>

        <% } %>

        <% if (book.status !== 'wishlist') { %>
            <div class="mt-4">
                <button class="btn btn-outline-dark w-100 p-3" 
                        style="border-style: dashed; border-width: 2px; opacity: 0.7;"
                        data-bs-toggle="modal" 
                        data-bs-target="#modalAddReview">
                    + Add New Entry
                </button>
            </div>
        <% } %>
        
      <% } %>
    </div>
  </div>
</div>

<% if (isInLibrary) { %>
  <%- include('../partials/modals', { book: book }) %>
<% } %>